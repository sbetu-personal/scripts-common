Here's a PowerShell script to automate the role assignments and removals. This script uses Azure CLI and handles both assignment and removal operations:

```powershell
<#
.SYNOPSIS
Assigns or removes Azure Reader and Storage Blob Data Reader roles for specified users across subscriptions.

.DESCRIPTION
This script requires Azure CLI and handles both assignment and removal of roles. Before running:
1. Install Azure CLI: https://docs.microsoft.com/en-us/cli/azure/install-azure-cli
2. Run `az login` and authenticate with an account that has Owner/User Access Administrator privileges
3. Modify the $SUBSCRIPTIONS and $USER_IDS variables below
#>

param(
    [Parameter(Mandatory=$true)]
    [ValidateSet("assign", "remove")]
    [string]$Operation
)

# ===== CONFIGURATION =====
# List of target subscription IDs (replace with your 12 subscription IDs)
$SUBSCRIPTIONS = @(
    "sub-id-1",
    "sub-id-2",
    "sub-id-3"
    # ... add all 12 subscription IDs
)

# List of user IDs (replace with your 4 user object IDs or user principal names)
$USER_IDS = @(
    "user1@domain.com",
    "user2@domain.com",
    "user3@domain.com",
    "user4@domain.com"
)

$ROLES = @(
    "Reader",
    "Storage Blob Data Reader"
)
# ===== END CONFIGURATION =====

# Initialize counters
$totalAssignments = $SUBSCRIPTIONS.Count * $USER_IDS.Count * $ROLES.Count
$processed = 0
$successCount = 0
$failCount = 0

foreach ($sub in $SUBSCRIPTIONS) {
    Write-Output "`nProcessing subscription: $sub"
    az account set --subscription $sub | Out-Null
    
    foreach ($userId in $USER_IDS) {
        foreach ($role in $ROLES) {
            $processed++
            $progress = [math]::Round(($processed / $totalAssignments) * 100)
            Write-Output "[$progress%] - $Operation $role for $userId in $sub"
            
            if ($Operation -eq "assign") {
                $result = az role assignment create `
                    --assignee $userId `
                    --role $role `
                    --scope "/subscriptions/$sub" `
                    2>&1
            }
            else {
                $result = az role assignment delete `
                    --assignee $userId `
                    --role $role `
                    --scope "/subscriptions/$sub" `
                    --yes `
                    2>&1
            }
            
            if ($LASTEXITCODE -eq 0) {
                $successCount++
                Write-Output "SUCCESS: Operation completed"
            }
            else {
                $failCount++
                Write-Output "ERROR: $result"
            }
        }
    }
}

Write-Output "`n===== OPERATION COMPLETE ====="
Write-Output "Total processed: $totalAssignments"
Write-Output "Successful operations: $successCount"
Write-Output "Failed operations: $failCount"
```

### Key Features:
1. **Dual Mode Operation**: Run with `-Operation assign` to add roles or `-Operation remove` to revoke access
2. **Progress Tracking**: Shows percentage completion during execution
3. **Error Handling**: Captures and reports errors without stopping execution
4. **Comprehensive Reporting**: Provides success/failure summary at completion

### Usage Instructions:
1. **Save the script** as `AzureRoleManager.ps1`
2. **Modify configuration**:
   - Replace values in `$SUBSCRIPTIONS` with your 12 subscription IDs
   - Replace values in `$USER_IDS` with your 4 user IDs (email or object IDs)
3. **Assign Roles**:
   ```powershell
   .\AzureRoleManager.ps1 -Operation assign
   ```
4. **Remove Roles After Testing**:
   ```powershell
   .\AzureRoleManager.ps1 -Operation remove
   ```

### Requirements:
1. Azure CLI installed ([Download here](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli))
2. User running the script must have:
   - `Owner` or `User Access Administrator` role on all target subscriptions
   - Azure AD permissions to assign roles
3. PowerShell 5.1 or newer

### Notes:
1. Test with 1 subscription and 1 user first to verify permissions
2. Role assignments may take several minutes to propagate through Azure
3. For recurring use, consider storing subscription IDs in an external file
4. The script will skip already assigned roles during assignment and non-existent assignments during removal

### Security Considerations:
1. Run using a privileged account with just-enough-permissions
2. Store script securely (Azure Key Vault or secure repository)
3. Audit role assignments regularly using:
   ```bash
   az role assignment list --all --output table
   ```

This script automates your requirement while providing clear feedback and error handling. The remove operation ensures clean-up after pen testing completes.


az account list --query "[].join('', ['\"', id, '\"', ',  //', name])" -o tsv

